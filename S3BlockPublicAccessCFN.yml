---
AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS CloudFormation template for Security controls '
Parameters:
  S3BlockPublicAcls:
    Type: String
    Description: Block new public ACLs and uploading public objects (Recommended)
    AllowedValues:
      - 'True'
      - 'False'
    Default: 'True'
  S3IgnorePublicAcls:
    Type: String
    Description: Remove public access granted through public ACLs (Recommended)
    AllowedValues:
      - 'True'
      - 'False'
    Default: 'True'
  S3BlockPublicPolicy:
    Type: String
    Description: Block new public bucket policies (Recommended)
    AllowedValues:
      - 'True'
      - 'False'
    Default: 'True'
  S3RestrictPublicBuckets:
    Type: String
    Description: Block public and cross-account access to buckets that have public policies (Recommended)
    AllowedValues:
      - 'True'
      - 'False'
    Default: 'True'

Resources:
  S3BlockPublicAccess:
    Type: Custom::S3BlockPublicAccess
    Properties:
      ServiceToken:
        Fn::GetAtt:
        - S3BlockPublicAccessFunction
        - Arn
      AccountId: !Ref AWS::AccountId
      S3BlockPublicAcls: !Ref S3BlockPublicAcls
      S3IgnorePublicAcls: !Ref S3IgnorePublicAcls
      S3BlockPublicPolicy: !Ref S3BlockPublicPolicy
      S3RestrictPublicBuckets: !Ref S3RestrictPublicBuckets

  S3BlockPublicAccessLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
      Policies:
      - PolicyName: root
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
          - Effect: Allow
            Action:
            - s3:GetAccountPublicAccessBlock
            - s3:PutAccountPublicAccessBlock
            Resource: "*"

  S3BlockPublicAccessFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: "S3BlockPublicAccessLambda"
      Code: ./lambda_codebase
      Handler:
        s3-block-public-access.lambda_handler
      Role:
        Fn::GetAtt:
        - S3BlockPublicAccessLambdaExecutionRole
        - Arn
      Runtime: python3.6
      Timeout: '30'
